build-and-deploy-backend:
  name: ðŸš€ Build & Deploy Backend
  runs-on: ubuntu-latest
  needs: test-backend

  steps:
    - uses: actions/checkout@v3

    - name: Login to DockerHub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Build Backend Image
      run: docker build -t docker.io/${{ secrets.DOCKER_USERNAME }}/mern-backend ./Backend

    - name: Push Backend Image
      run: docker push docker.io/${{ secrets.DOCKER_USERNAME }}/mern-backend

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_KEY_JSON }}

    - name: Setup Cloud SQL Auth Proxy
      uses: google-github-actions/setup-cloud-sql-proxy@v1
      with:
        credentials_json: ${{ secrets.GCP_KEY_JSON }}
        instance: ${{ secrets.CLOUD_SQL_INSTANCE }}

    - name: Deploy Backend to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service: mern-backend
        image: docker.io/${{ secrets.DOCKER_USERNAME }}/mern-backend
        region: us-central1
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        flags: --platform managed --allow-unauthenticated
